name: Deploy Static

on:
  workflow_run:
    workflows: ["Build Static Artifact"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-static:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    name: Deploy Static Site to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Download static site artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-cto-portfolio-static-${{ github.ref_name }}
          path: ./static-site
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Verify and create deployment archive
        run: |
          echo "ðŸ” Checking downloaded artifact..."
          if [ ! -d "./static-site" ] || [ ! "$(ls -A ./static-site)" ]; then
            echo "âŒ ERROR: Static site artifact is empty or missing"
            echo "Available files:"
            ls -la ./ || true
            ls -la ./static-site/ || true
            exit 1
          fi
          
          echo "âœ… Artifact downloaded successfully"
          echo "ðŸ“Š Files in artifact: $(find ./static-site -type f | wc -l) files"
          echo "ðŸ“Š Total size: $(du -sh ./static-site | cut -f1)"
          
          echo "ðŸ“¦ Creating deployment archive..."
          cd static-site
          tar -czf ../nextjs-cto-portfolio-static-${{ github.ref_name }}.tar.gz .
          cd ..
          
          echo "âœ… Archive created successfully"
          ls -la nextjs-cto-portfolio-static-${{ github.ref_name }}.tar.gz

      - name: Upload deployment archive via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER_NAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "nextjs-cto-portfolio-static-${{ github.ref_name }}.tar.gz"
          target: "${{ secrets.STATIC_TEMP_PATH }}/"
          overwrite: true

      - name: Deploy static site
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_PATH: ${{ secrets.STATIC_DEPLOY_PATH }}
          TEMP_PATH: ${{ secrets.STATIC_TEMP_PATH }}
          BRANCH_NAME: ${{ github.ref_name }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER_NAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DEPLOY_PATH,TEMP_PATH,BRANCH_NAME
          script_stop: true
          script: |
            set -e  # Exit immediately if any command fails
            
            echo "ðŸ” Checking for deployment archive..."
            ARCHIVE_FILE="${TEMP_PATH}/nextjs-cto-portfolio-static-${BRANCH_NAME}.tar.gz"
            
            if [ ! -f "$ARCHIVE_FILE" ]; then
              echo "âŒ ERROR: Deployment archive not found at: $ARCHIVE_FILE"
              echo "Available files in temp directory:"
              ls -la "${TEMP_PATH}/" || echo "Temp directory not accessible"
              exit 1
            fi
            
            echo "âœ… Archive found: $ARCHIVE_FILE"
            echo "ðŸ“Š Archive size: $(du -sh "$ARCHIVE_FILE" | cut -f1)"
                        
            echo "ðŸ§¹ Removing existing files..."
            sudo rm -rf ${DEPLOY_PATH}/*
            
            echo "ðŸ“¦ Extracting new deployment..."
            sudo tar -xzf "$ARCHIVE_FILE" -C "${DEPLOY_PATH}/"
            
            echo "ðŸ” Verifying extraction..."
            if [ ! "$(ls -A ${DEPLOY_PATH})" ]; then
              echo "âŒ ERROR: Deployment directory is empty after extraction"
              exit 1
            fi
            
            echo "âœ… Deployment extracted successfully"
            echo "ðŸ“Š Deployed files: $(find ${DEPLOY_PATH} -type f | wc -l) files"
            
            echo "ðŸ§¹ Cleaning up temp archive..."
            rm -f "$ARCHIVE_FILE"
            
            echo "ðŸŽ‰ Deployment completed successfully!"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Static Site Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Type:** Static Files to Production Server" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** nextjs-cto-portfolio-static-${{ github.ref_name }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Method:** (SCP + SSH extraction)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ï¿½ Deployment Process" >> $GITHUB_STEP_SUMMARY
          echo "1. **Archive Creation** - Packaged static files into deployment archive" >> $GITHUB_STEP_SUMMARY
          echo "2. **File Transfer** - Uploaded archive to server via SCP" >> $GITHUB_STEP_SUMMARY  
          echo "3. **Site Replacement** - Removed all existing files (rm -rf)" >> $GITHUB_STEP_SUMMARY
          echo "4. **Content Extraction** - Extracted new files directly to deployment path" >> $GITHUB_STEP_SUMMARY
          echo "5. **Cleanup** - Removed temporary deployment archive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- **File Deployment:** âœ… Complete - All static files deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Site Replacement:** âœ… Clean - Previous version completely replaced" >> $GITHUB_STEP_SUMMARY
          echo "- **Server Cleanup:** âœ… Done - No temporary files remaining" >> $GITHUB_STEP_SUMMARY